<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>
</head>
<body>
	<canvas id="canvas" width="500" height="500"></canvas>
	<script type="text/javascript">
		function loadImage(fn) {
			return new Promise((resolve, reject) => {
				const img = new Image();
				img.addEventListener('load', () => resolve(img));
				img.addEventListener('error', e => reject(e));
				img.src = `sprites/${fn}.png`;
			});
		}

		function hex(n) {
			const str = n.toString(16);
			if (str.length === 1) return '0' + str;
			return str;
		}

		function col2hex(r, g, b, a) {
			return `#${hex(r)}${hex(g)}${hex(b)}${hex(a)}`;
		}

		function img2pix(image) {
			const canvas = document.createElement('canvas');
			canvas.width = image.naturalWidth;
			canvas.height = image.naturalHeight;
			const context = canvas.getContext('2d');
			context.drawImage(image, 0, 0);
			const { data } = context.getImageData(0, 0, canvas.width, canvas.height);
			console.log(canvas.width, canvas.height, data.length)
			const pixels = [];
			let i = 0;
			for (let y = 0; y < canvas.height; ++y) {
				const row = [];
				pixels.push(row);
				for (let x = 0; x < canvas.width; ++x) {
					console.log(x, y, i)
					row.push(col2hex(data[i++], data[i++], data[i++], data[i++]));
				}
			}
			return pixels;
		}

		function drawImage(context, pixels, pixelSize, positioner) {
			const d = pixelSize / 2;
			pixels.forEach((row, y) =>
				row.forEach((colour, x) => {
					const pos = positioner(x, y);
					context.fillStyle = colour;
					context.fillRect(pos.x - d, pos.y - d, pixelSize, pixelSize);
				})
			);
		}

		(async function() {
			const image = await loadImage('mario');
			const pix = img2pix(image);
			const canvas = document.getElementById('canvas');
			const context = canvas.getContext('2d');
			console.log(pix);
			drawImage(context, pix, 25, (x, y) => ({ x: 250 + (x - 8) * 26, y: 250 + (y - 8) * 26 }))
		})();
	</script>
</body>
</html>