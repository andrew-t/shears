<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title></title>
	<style type="text/css">
		label {
			display: flex;
		}

		label span {
			flex: 0 0 10em;
		}

		label input {
			flex: 1 0 1em;
		}
	</style>
</head>
<body>
	<canvas id="canvas" width="500" height="500"></canvas>
	<label id="mode">
		<span>Mode</span>
		<select id="mode-select">
			<option value="comparison">Compare true rotation to three-shears rotation</option>
			<option value="shears">Apply three-shears rotation step by step</option>
			<option value="shears-unrounded">Apply three-shears rotation without rounding</option>
		</select>
	</label>
	<label id="theta">
		<span>Angle</span>
		<input id="theta-slider" type="range" min="-100" max="100">
		<span id="theta-output"></span>
	</label>
	<label id="p">
		<span>Lerp</span>
		<input id="p-slider" type="range" min="0" max="100">
		<span id="p-output"></span>
	</label>
	<label id="base-p">
		<span>Global lerp</span>
		<input id="base-p-slider" type="range" min="0" max="100">
		<span id="base-p-output"></span>
	</label>
	<label id="zoom">
		<span>Zoom</span>
		<input id="zoom-slider" type="range" min="0" max="100">
		<span id="zoom-output"></span>
	</label>
	<label id="border">
		<span>Border</span>
		<input id="border-slider" type="range" min="0" max="100">
		<span id="border-output"></span>
	</label>

	<script type="text/javascript">
		const π = Math.PI;

		function loadImage(fn) {
			return new Promise((resolve, reject) => {
				const img = new Image();
				img.addEventListener('load', () => resolve(img));
				img.addEventListener('error', e => reject(e));
				img.src = `sprites/${fn}.png`;
			});
		}

		function hex(n) {
			const str = n.toString(16);
			if (str.length === 1) return '0' + str;
			return str;
		}

		function col2hex(r, g, b, a) {
			return `#${hex(r)}${hex(g)}${hex(b)}${hex(a)}`;
		}

		function img2pix(image) {
			const canvas = document.createElement('canvas');
			canvas.width = image.naturalWidth;
			canvas.height = image.naturalHeight;
			const context = canvas.getContext('2d');
			context.drawImage(image, 0, 0);
			const { data } = context.getImageData(0, 0, canvas.width, canvas.height);
			// console.log(canvas.width, canvas.height, data.length)
			const pixels = [];
			let i = 0;
			for (let y = 0; y < canvas.height; ++y) {
				const row = [];
				pixels.push(row);
				for (let x = 0; x < canvas.width; ++x) {
					// console.log(x, y, i)
					row.push(col2hex(data[i++], data[i++], data[i++], data[i++]));
				}
			}
			return pixels;
		}

		function drawImage(context, pixels, pixelSize, positioner) {
			const d = pixelSize / 2;
			pixels.forEach((row, y) =>
				row.forEach((colour, x) => {
					if (colour.endsWith('00')) return;
					const pos = positioner({ x, y });
					context.fillStyle = colour;
					context.fillRect(pos.x - d, pos.y - d, pixelSize, pixelSize);
				})
			);
		}

		function scale(sourceOffset, destOffset, scale) {
			return ({ x, y }) => ({
				x: destOffset + (x - sourceOffset) * scale,
				y: destOffset + (y - sourceOffset) * scale
			});
		}

		function skewX(ratio) {
			return ({ x, y }) => ({
				x: x + y * ratio,
				y
			});
		}

		function skewY(ratio) {
			return ({ x, y }) => ({
				x,
				y: y + x * ratio
			});
		}

		function scaleX(scale) {
			return ({ x, y }) => ({
				x: x * scale,
				y
			});
		}
		function scaleY(scale) {
			return ({ x, y }) => ({
				x,
				y: y * scale
			});
		}

		function roundX(offset, unit) {
			return ({ x, y }) => ({
				x: Math.floor(x),
				y
			});
		}
		function roundY(offset, unit) {
			return ({ x, y }) => ({
				x,
				y: Math.floor(y)
			});
		}

		function lerp(transform, p) {
			return i => {
				const f = transform(i);
				const q = 1 - p;
				return {
					x: i.x * q + f.x * p,
					y: i.y * q + f.y * p
				};
			};
		}

		function lerp2(transformA, transformB, p) {
			return input => {
				const i = transformA(input);
				const f = transformB(input);
				const q = 1 - p;
				return {
					x: i.x * q + f.x * p,
					y: i.y * q + f.y * p
				};
			};
		}

		function rotate(theta) {
			const sin = Math.sin(theta);
			const cos = Math.cos(theta);
			return ({ x, y }) => {
				return {
					x: x * cos + y * sin,
					y: y * cos - x * sin
				};
			};
		}

		function stack(...transforms) {
			// console.log(transforms);
			return input => transforms.reduce((a, n) => n(a), input);
		}

		function pass() {
			return input => input;
		}

		(async function() {
			const image = await loadImage('mario');
			const pix = img2pix(image);
			const canvas = document.getElementById('canvas');
			const context = canvas.getContext('2d');

			const pSlider = document.getElementById('p-slider');
			const basePSlider = document.getElementById('base-p-slider');
			const thetaSlider = document.getElementById('theta-slider');
			const zoomSlider = document.getElementById('zoom-slider');
			const borderSlider = document.getElementById('border-slider');
			const modeDropdown = document.getElementById('mode-select');

			function drawComparison(theta) {
				document.getElementById("p-output").innerHTML = pSlider.value / 100;

				const a = Math.tan(theta / 2);
				const b = -Math.sin(theta);
				return lerp2(
					rotate(theta),
					stack(
						skewX(a),
						roundX(),
						skewY(b),
						roundY(),
						skewX(a),
						roundX()
					),
					pSlider.value / 100
				)
			}

			function drawShears(theta, rounding) {
				// steps:
				// 1. break into rows
				// 2. slide rows
				// 3. recombine
				// 4. pause
				// 5-7. same with columns
				// 8. pause
				// 9-11. rows again
				const pp = pSlider.value / (100 / 11);
				const step = Math.floor(pp);
				const p = pp % 1;
				const a = Math.tan(theta / 2);
				const b = -Math.sin(theta);
				document.getElementById("p-output").innerHTML = step + p;
				const rx = rounding ? roundX : pass,
					ry = rounding ? roundY : pass;
				switch (step) {
					case 0:
						return lerp(scaleY(1.5), p);
					case 1:
						return stack(
							lerp(stack(skewX(a), rx()), p),
							scaleY(1.5)
						);
					case 2:
						return stack(
							skewX(a),
							rx(),
							lerp(scaleY(1.5), 1 - p)
						);
					case 3:
						return stack(skewX(a), rx());
					case 4:
						return stack(
							skewX(a),
							rx(),
							lerp(scaleX(1.5), p)
						);
					case 5:
						return stack(
							skewX(a),
							rx(),
							lerp(stack(skewY(b), ry()), p),
							scaleX(1.5)
						);
						break;
					case 6:
						return stack(
							skewX(a),
							rx(),
							skewY(b),
							ry(),
							lerp(scaleX(1.5), 1 - p)
						);
					case 7:
						return stack(
							skewX(a),
							rx(),
							skewY(b),
							ry()
						);
					case 8:
						return stack(
							skewX(a),
							rx(),
							skewY(b),
							ry(),
							lerp(scaleY(1.5), p)
						);
					case 9:
						return stack(
							skewX(a),
							rx(),
							skewY(b),
							ry(),
							lerp(stack(skewX(a), rx()), p),
							scaleY(1.5)
						);
					case 10:
						return stack(
							skewX(a),
							rx(),
							skewY(b),
							ry(),
							skewX(a),
							rx(),
							lerp(scaleY(1.5), 1 - p)
						);
					case 11:
						return stack(
							skewX(a),
							rx(),
							skewY(b),
							ry(),
							skewX(a),
							rx()
						);
				}
			}

			function getTransforms() {
				const theta = thetaSlider.value * π / 100;
				document.getElementById("theta-output").innerHTML = `${theta / π}π`;

				switch (modeDropdown.value) {
					case 'comparison': return drawComparison(theta);
					case 'shears': return drawShears(theta, true);
					case 'shears-unrounded': return drawShears(theta, false);
				}
			}

			function draw() {
				context.clearRect(0, 0, 500, 500);

				const pixSize = zoomSlider.value / 4,
					pScale = pixSize * (1 + borderSlider.value / 100);
				document.getElementById("zoom-output").innerHTML = pixSize;
				document.getElementById("border-output").innerHTML = pScale - pixSize;

				document.getElementById("base-p-output").innerHTML = basePSlider.value / 100;

				drawImage(context, pix, pixSize, stack(
					scale(7.5, 0, 1),
					lerp(getTransforms(), basePSlider.value / 100),
					scale(0, canvas.width / 2, pScale)
				));
			}

			pSlider.addEventListener('input', draw);
			basePSlider.addEventListener('input', draw);
			thetaSlider.addEventListener('input', draw);
			zoomSlider.addEventListener('input', draw);
			borderSlider.addEventListener('input', draw);
			modeDropdown.addEventListener('change', draw);
			draw();
		})();
	</script>
</body>
</html>